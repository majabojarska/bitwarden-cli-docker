name: Update Bitwarden CLI version tag

on:
  schedule:
    - cron: "0 8 * * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update_deps:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Get latest Bitwarden CLI version
        run: |
          # The GH API guarantees the releases will be sorted (latest to oldest).
          # No need to sort here.
          echo BW_CLI_VERSION_LATEST=$(curl --silent \
            https://api.github.com/repos/bitwarden/clients/releases\?per_page\=100 \
            | jq --raw-output '
              first(
                .[] | .assets | .[] |
                select((.name | startswith("bw-oss-linux")) and (.name | endswith("zip"))) |
                .name
              ) | capture("(?<ver>[0-9]{4}[.][0-1][0-9][.][0-9]{1,3})").ver' \
            ) >> $GITHUB_ENV

      - name: Replace BW_CLI_VERSION with latest tag
        run: |
          # Match line and replace whole
          sed --in-place "/ARG BW_CLI_VERSION=*/s/.*/ARG BW_CLI_VERSION=${BW_CLI_VERSION_LATEST}/" Dockerfile

      - name: Git diff
        run: |
          git diff

      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PR_CREATE_PAT }}
          branch: auto-update-cli
          commit-message: Update Bitwarden CLI
          title: Update Bitwarden CLI to ${{ env.BW_CLI_VERSION_LATEST }}
          body: |
            ## Beep boop ü§ñ. Fresh CLI incoming ‚ôªÔ∏è!

            Auto-generated by [create-pull-request][1]

            [1]: https://github.com/peter-evans/create-pull-request
